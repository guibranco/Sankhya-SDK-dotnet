# Sankhya SDK

📊⚙️ [Sankhya](https://www.sankhya.com.br/) .NET SDK.

[![GitHub license](https://img.shields.io/github/license/guibranco/Sankhya-SDK-dotnet)](https://github.com/guibranco/Sankhya-SDK-dotnet)
[![Time tracker](https://wakatime.com/badge/github/guibranco/Sankhya-SDK-dotnet.svg)](https://wakatime.com/badge/github/guibranco/Sankhya-SDK-dotnet)

![Sankhya logo](https://raw.githubusercontent.com/guibranco/Sankhya-SDK-dotnet/main/logo.png)

## CI/CD

| Build status | Last commit | Tests | Coverage | Code Smells | LoC | 
|--------------|-------------|-------|----------|-------------|-----|
| [![Build status](https://ci.appveyor.com/api/projects/status/e1midttew0yykr59/branch/main?svg=true)](https://ci.appveyor.com/project/guibranco/Sankhya-SDK-dotnet/branch/main) | [![GitHub last commit](https://img.shields.io/github/last-commit/guibranco/Sankhya-SDK-dotnet/main)](https://github.com/guibranco/Sankhya-SDK-dotnet) | [![AppVeyor tests (branch)](https://img.shields.io/appveyor/tests/guibranco/Sankhya-SDK-dotnet/main?compact_message)](https://ci.appveyor.com/project/guibranco/Sankhya-SDK-dotnet/branch/main/tests) | [![Coverage](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=coverage)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet) | [![Code Smells](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=code_smells)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet) | [![Lines of Code](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=ncloc)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)

## Code Quality

[![Codacy Badge](https://app.codacy.com/project/badge/Grade/f6d787f9a2fe4116a7a8a0043489ba67)](https://www.codacy.com/gh/guibranco/Sankhya-SDK-dotnet/dashboard?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=guibranco/Sankhya-SDK-dotnet&amp;utm_campaign=Badge_Grade)
[![Codacy Badge](https://app.codacy.com/project/badge/Coverage/f6d787f9a2fe4116a7a8a0043489ba67)](https://www.codacy.com/gh/guibranco/Sankhya-SDK-dotnet/dashboard?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=guibranco/Sankhya-SDK-dotnet&amp;utm_campaign=Badge_Coverage)

[![codecov](https://codecov.io/gh/guibranco/Sankhya-SDK-dotnet/branch/main/graph/badge.svg)](https://codecov.io/gh/guibranco/Sankhya-SDK-dotnet)
[![CodeFactor](https://www.codefactor.io/repository/github/guibranco/Sankhya-SDK-dotnet/badge)](https://www.codefactor.io/repository/github/guibranco/Sankhya-SDK-dotnet)

[![Maintainability](https://api.codeclimate.com/v1/badges/d753c91651260c3da761/maintainability)](https://codeclimate.com/github/guibranco/Sankhya-SDK-dotnet/maintainability)
[![Test Coverage](https://api.codeclimate.com/v1/badges/d753c91651260c3da761/test_coverage)](https://codeclimate.com/github/guibranco/Sankhya-SDK-dotnet/test_coverage)

[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=alert_status)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)
[![Maintainability Rating](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=sqale_rating)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)

[![Technical Debt](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=sqale_index)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)
[![Duplicated Lines (%)](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=duplicated_lines_density)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)

[![Reliability Rating](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=reliability_rating)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)
[![Security Rating](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=security_rating)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)

[![Bugs](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=bugs)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)
[![Vulnerabilities](https://sonarcloud.io/api/project_badges/measure?project=guibranco_Sankhya-SDK-dotnet&metric=vulnerabilities)](https://sonarcloud.io/dashboard?id=guibranco_Sankhya-SDK-dotnet)

---

## Installation

### Github Releases

[![GitHub last release](https://img.shields.io/github/release-date/guibranco/Sankhya-SDK-dotnet.svg?style=flat)](https://github.com/guibranco/Sankhya-SDK-dotnet) [![Github All Releases](https://img.shields.io/github/downloads/guibranco/Sankhya-SDK-dotnet/total.svg?style=flat)](https://github.com/guibranco/Sankhya-SDK-dotnet)

Download the latest zip file from the [Release](https://github.com/GuiBranco/Sankhya-SDK-dotnet/releases) page.

### Nuget package manager

| Package | Version | Downloads |
|------------------|:-------:|:-------:|
| **Sankhya** | [![Sankhya NuGet Version](https://img.shields.io/nuget/v/Sankhya.svg?style=flat)](https://www.nuget.org/packages/Sankhya/) | [![Sankhya NuGet Downloads](https://img.shields.io/nuget/dt/Sankhya.svg?style=flat)](https://www.nuget.org/packages/Sankhya/) |

---

## Features

This SDK implements many Sankhya's web service. Some of then are called `Know Services`.
If the service that you looking for is not set in the SDK you can implement the service request/response by your own (and use it on your code or submit a pull request to this repository).

There are also some `Request Wrappers` that allows you to make some requests in an easy way.

### Known Services

- MobileLoginSP
  - login
  - logout
- CRUD
  - find
  - remove
  - save
- CRUDServiceProvider
  - loadRecords
  - removeRecord
  - saveRecord
- ServicosNfeSP
  - buscaProcessamentoLote
  - gerarLote
  - getAcompanhamentosNota
- CACSP
  - incluirNota
  - incluirAlterarCabecalhoNota
  - incluirAlterarItemNota
  - confirmarNota
  - cancelarNota
  - duplicarNota
  - excluirNotas
  - excluirItemNota
  - ligarPedidoNota
  - marcarPedidosComoNaoPendentes
- SelecaoDocumentoSP
  - faturar
- BaixaAutomaticaSP
  - baixar
- BaixaFinanceiroSP
  - estornarTitulo
- AvisoSistemaSP
  - getNovosAvisos
  - enviarAviso
  - enviarMensagem
- RepositorioArquivoSP
  - abreArquivo
- ImportacaoImagemSP
  - deletaArquivos
- SessionManagerSP
  - getCoreSessions
  - killSession
- MovimentacaoFinanceiraSP
  - desvincularRemessa

### Request Wrappers

- Know Services Request Wrapper - This implements all known services described below, with predefined parameters, if the existing parameter set doesn't suit your need, you can execute the request without the wrapper.
- On Demand Request Wrapper - This manage the request reusing the authentication flow, so it holds the same session over multiple requests.
- Paged Request Wrapper - Retrieve data using paged CRUD.

### Main Wrappers

- Low Level Sankhya Wrapper - **NOT IMPLEMENTED YET**.
- Sankhya Wrapper -  The main wrapper.
  
### Sankhya Wrapper

The *last mile operations* are done on this wrappers.
ALl HTTP request/responses, login/logout, serialization, download/upload operations are defined on this class.

**Avoid** usage of this class directly from you implementation. Only call methods of this class if you are extending the usage of the SDK or even implementing a new feature for the SDK, otherwise, prefer using one of the request wrappers, or the Sankhya Context class.

---

## Usage

### Service registration (IoC / DI)

This SDK is based on [CrispyWaffle toolkit](https://github.com/guibranco/CrispyWaffle), so you can use it's [Service Locator](https://guibranco.github.io/CrispyWaffle/user-guide/serviceLocator/) feature to register it.

Assuming you are using Crispy Waffle, you can register the Sankhya wrapper in the Bootstrapper.cs file this way:

```cs
var connectionSankhya = new Connection(); //Fill in your details
ServiceLocator.Register(() => new SankhyaContext(connectionSankhya), LifeStyle.Singleton);
```

Later, when you need to access the [Sankhya Context]() in you code, you can just pass it as constructor's argument or retrieve it from **Service Locator**

#### Constructor argument

```cs
public class MyClass {

    private readonly SankhyaContext _sankhyaContext;

    public MyClass(SankhyaContext sankyaContext) {
        _sankhyaContext = sankhyaContext ?? throw new ArgumentNullException(nameof(sankhyaContext));
    }
}
```

#### Retrieving manually

```cs
var sankhyaContext = ServiceLocator.Resolve<SankhyaContext>();
```

### Know Services Wrapper

The `KnowServicesRequestWrapper` is a static class that can be used anywhere, since SankhyaContext is registered through ServiceLocator.

### Session management

You can use this to get all active sessions in Sankhya and kill one by one:

```cs
var sessions = KnowServicesRequestWrapper.GetSessions();
foreach (var session in sessions) {
    KnowServicesRequestWrapper.KillSession(session.Id);
}
```
